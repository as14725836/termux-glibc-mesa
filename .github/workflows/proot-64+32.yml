name: proot 64+32 Mesa (aarch64 + armhf, Auto Update + Detailed Log)
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'refs/tags/**'
  schedule:
    - cron: "0 22 * * *"
permissions:
  contents: write
  actions: write
jobs:
  check-updates:
    runs-on: ubuntu-24.04-arm
    outputs:
      new_commit: ${{ steps.check.outputs.new_commit }}
      latest_hash: ${{ steps.check.outputs.latest_hash }}
    steps:
      - name: æ£€æŸ¥ Mesa ä¸Šæ¸¸æ›´æ–°
        id: check
        run: |
          echo "ðŸ” æ£€æŸ¥ Mesa ä¸Šæ¸¸æäº¤..."
          LATEST_HASH=$(git ls-remote https://gitlab.freedesktop.org/mesa/mesa.git refs/heads/main | awk '{print $1}')
          echo "æœ€æ–°ä¸Šæ¸¸æäº¤: $LATEST_HASH"
          
          STATE_FILE=".mesa_latest_commit"
          if [ -f "$STATE_FILE" ]; then
            LAST_HASH=$(cat $STATE_FILE)
          else
            LAST_HASH=""
          fi
          echo "ä¸Šæ¬¡æž„å»º: $LAST_HASH"
          
          if [ "$LATEST_HASH" != "$LAST_HASH" ]; then
            echo "new_commit=true" >> $GITHUB_OUTPUT
            echo "latest_hash=$LATEST_HASH" >> $GITHUB_OUTPUT
          else
            echo "new_commit=false" >> $GITHUB_OUTPUT
          fi
  build:
    needs: check-updates
    if: ${{ needs.check-updates.outputs.new_commit == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    runs-on: ubuntu-24.04-arm
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      - name: æ˜¾ç¤ºæž„å»ºçŽ¯å¢ƒä¿¡æ¯
        run: |
          lsb_release -a || true
          uname -a
          lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'
          free -h
          df -h
      
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
          sudo apt update
          sudo apt install -y glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
            libxext-dev llvm-19 libwayland-egl-backend-dev libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxshmfence-dev libdrm-dev \
            libgbm-dev libegl1-mesa-dev libexpat1-dev libwayland-dev python3-pip openssh-server \
            pulseaudio libasound2-plugins wget unzip cmake git g++-arm-linux-gnueabihf
          pip3 install --user meson ninja mako
      
      - name: æ·»åŠ armhfæž¶æž„æ”¯æŒå¹¶å®‰è£…32ä½ä¾èµ–
        run: |
          echo "ðŸ”„ æ·»åŠ armhfæž¶æž„æ”¯æŒ..."
          sudo dpkg --add-architecture armhf
          sudo apt update
          sudo apt upgrade -y
          
          echo "ðŸ“¦ å®‰è£…32ä½ä¾èµ–åŒ…..."
          sudo apt install -y zenity:armhf libasound2:armhf libasound2-dev:armhf libstdc++6:armhf \
            zlib1g-dev:armhf libexpat1-dev:armhf libdrm-dev:armhf libx11-dev:armhf \
            libxext-dev:armhf libxdamage-dev:armhf libxcb-glx0-dev:armhf libx11-xcb-dev:armhf \
            libxcb-dri2-0-dev:armhf libxcb-dri3-dev:armhf libxcb-present-dev:armhf \
            libxshmfence-dev:armhf libxxf86vm-dev:armhf libxrandr-dev:armhf libwayland-dev:armhf \
            wayland-protocols:armhf libwayland-egl-backend-dev:armhf libxcb-shm0-dev:armhf \
            pkg-config:armhf libgbm-dev:armhf libegl1-mesa-dev:armhf
          
          echo "ðŸ“¦ å®‰è£…mesaæž„å»ºä¾èµ–..."
          sudo apt build-dep mesa -y
          sudo apt install -f -y
      
      - name: å…‹éš† Mesa æ­£å¼ç‰ˆ
        run: |
          echo "ðŸ“¥ å…‹éš† Mesa ä»“åº“..."
          git clone https://github.com/fish4terrisa-MSDSM/mesa-kgsl-25.2.5.git
          cd mesa-kgsl-25.2.5
      
      - name: è‡ªå®šä¹‰å“ç‰Œ
        run: |
          echo "ðŸ”§ è‡ªå®šä¹‰å“ç‰Œ: Turnip â†’ Qualcomm Snapdragon"
          cd mesa-kgsl-25.2.5
          sed -i 's/Turnip Adreno (TM) %s%s/Qualcomm Snapdragon Adreno (TM) %s%s/' src/freedreno/vulkan/tu_device.cc
          sed -i 's/"turnip Mesa driver"/"Qualcomm Snapdragon Driver"/' src/freedreno/vulkan/tu_device.cc
          sed -i 's/"Mesa " PACKAGE_VERSION MESA_GIT_SHA1/"Qualcomm Snapdragon " PACKAGE_VERSION MESA_GIT_SHA1/' src/freedreno/vulkan/tu_device.cc
      
      - name: æž„å»º64ä½Mesa
        run: |
          cd mesa-kgsl-25.2.5
          BUILD_START=$(date +%s)
          sudo mkdir -p /opt/mesa
          sudo chmod 777 -R /opt
          
          echo "ðŸ—ï¸ å¼€å§‹æž„å»º64ä½Mesa..."
          mkdir -p builddir64
          meson setup builddir64 \
            --libdir=lib/aarch64-linux-gnu \
            -Dprefix=/opt/mesa \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Db_lto=true \
            -Dplatforms=x11,wayland \
            -Degl-native-platform=wayland \
            -Dglx=dri \
            -Dglx-direct=true \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=disabled \
            -Dshared-llvm=disabled \
            -Dshader-cache=enabled \
            -Dshared-glapi=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dgallium-rusticl=false \
            -Dgallium-extra-hud=true \
            -Dgallium-drivers=zink,freedreno \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dgbm=enabled \
            -Dtools=drm-shim,freedreno \
            -Db_ndebug=true \
            -Db_lto=true \
            -Dstrip=true
          
          ninja -C builddir64 -j$(nproc)
          ninja -C builddir64 install
          
          BUILD_END=$(date +%s)
          echo "64ä½æž„å»ºè€—æ—¶: $((BUILD_END - BUILD_START)) ç§’"
      
      - name: æž„å»º32ä½Mesa
        run: |
          cd mesa-kgsl-25.2.5
          BUILD_START=$(date +%s)
          
          echo "ðŸ—ï¸ å¼€å§‹æž„å»º32ä½Mesa..."
          mkdir -p builddir32
          
          # è®¾ç½®32ä½äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export LD="arm-linux-gnueabihf-ld"
          export PKG_CONFIG_PATH="/usr/lib/arm-linux-gnueabihf/pkgconfig:$PKG_CONFIG_PATH"
          export PKG_CONFIG_LIBDIR="/usr/lib/arm-linux-gnueabihf/pkgconfig"
          
          meson setup builddir32 \
            --cross-file /usr/share/meson/cross/arm-linux-gnueabihf \
            --libdir=lib/arm-linux-gnueabihf \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Dprefix=/opt/mesa \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dglx-direct=true \
            -Dopengl=true \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=disabled \
            -Dshared-llvm=disabled \
            -Dshader-cache=enabled \
            -Dshared-glapi=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dgallium-drivers=zink,freedreno \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dgbm=enabled \
            -Db_ndebug=true \
            -Db_lto=true \
            -Dstrip=true
          
          ninja -C builddir32 -j$(nproc)
          
          # å®‰è£…32ä½åº“åˆ°æŒ‡å®šç›®å½•
          sudo mkdir -p /opt/mesa/lib/arm-linux-gnueabihf
          sudo cp -r builddir32/src/glx/.libs/* /opt/mesa/lib/arm-linux-gnueabihf/ || true
          sudo cp -r builddir32/src/egl/.libs/* /opt/mesa/lib/arm-linux-gnueabihf/ || true
          sudo cp -r builddir32/src/mesa/.libs/* /opt/mesa/lib/arm-linux-gnueabihf/ || true
          sudo cp -r builddir32/src/gallium/targets/*/.libs/* /opt/mesa/lib/arm-linux-gnueabihf/ || true
          
          BUILD_END=$(date +%s)
          echo "32ä½æž„å»ºè€—æ—¶: $((BUILD_END - BUILD_START)) ç§’"
          
          VERSION=$(cat VERSION)
          GIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "GIT_HASH=${GIT_HASH}" >> $GITHUB_ENV
      
      - name: æ‰“åŒ…æž„å»ºäº§ç‰©
        run: |
          echo "ðŸ“¦ å¼€å§‹æ‰“åŒ…Mesaäº§ç‰©..."
          cd mesa-kgsl-25.2.5
          PACK_START=$(date +%s)
          
          TAR_NAME="proot-mesa-${VERSION}-multiarch.tar.gz"
          tar -czvf "../${TAR_NAME}" -C /opt/mesa .
          
          PACK_END=$(date +%s)
          echo "æ‰“åŒ…è€—æ—¶: $((PACK_END - PACK_START)) ç§’"
          
          echo "ARTIFACT_NAME=${TAR_NAME}" >> $GITHUB_ENV
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mesa-proot-multiarch
          path: ${{ env.ARTIFACT_NAME }}
      
      - name: æ›´æ–°çŠ¶æ€æ–‡ä»¶
        run: |
          LATEST_HASH=${{ needs.check-updates.outputs.latest_hash }}
          if [ -n "$LATEST_HASH" ]; then
            echo "$LATEST_HASH" > .mesa_latest_commit
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add .mesa_latest_commit
            git commit -m "Update mesa latest commit to $LATEST_HASH"
            git push
          fi
