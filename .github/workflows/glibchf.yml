name: Build Glibc for ARMhf (简化保留路径)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      glibc_version:
        description: "Glibc版本"
        required: true
        default: "2.41"

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: 安装ARMhf交叉编译工具
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            wget xz-utils bison flex
      
      - name: 下载Glibc源代码
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          echo "下载 glibc-${VERSION}"
          wget -q "https://ftp.gnu.org/gnu/glibc/glibc-${VERSION}.tar.xz"
          tar -xf "glibc-${VERSION}.tar.xz"
          echo "文件已下载: glibc-${VERSION}"
      
      - name: 配置和编译ARMhf Glibc
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          cd "glibc-${VERSION}"
          
          echo "配置 glibc..."
          mkdir -p build
          cd build
          
          ../configure \
            --prefix=/usr \
            --host=arm-linux-gnueabihf \
            --disable-multilib \
            --enable-kernel=4.4
          
          echo "编译 glibc..."
          make -j$(nproc)
          
          echo "编译完成"
      
      - name: 安装并创建lib32结构
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          
          # 创建安装目录
          mkdir -p "/tmp/glibc-install"
          cd "glibc-${VERSION}/build"
          
          # 安装到临时目录
          echo "安装到临时目录..."
          DESTDIR="/tmp/glibc-install" make install
          
          # 创建 glibc/lib32 结构
          mkdir -p "/tmp/glibc/lib32"
          
          # 复制 ARMhf 库文件
          echo "复制库文件到 lib32..."
          if [ -d "/tmp/glibc-install/usr/lib/arm-linux-gnueabihf" ]; then
            cp -r "/tmp/glibc-install/usr/lib/arm-linux-gnueabihf/"* "/tmp/glibc/lib32/"
          fi
          
          if [ -d "/tmp/glibc-install/lib/arm-linux-gnueabihf" ]; then
            cp -r "/tmp/glibc-install/lib/arm-linux-gnueabihf/"* "/tmp/glibc/lib32/"
          fi
          
          # 列出文件确认
          echo "lib32 目录内容:"
          ls -la "/tmp/glibc/lib32/" || echo "lib32目录为空"
          
          # 创建版本文件
          echo "Glibc ${VERSION} for ARMhf" > "/tmp/glibc/version.txt"
          echo "Built: $(date)" >> "/tmp/glibc/version.txt"
          echo "Architecture: arm-linux-gnueabihf" >> "/tmp/glibc/version.txt"
      
      - name: 打包文件
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          
          echo "当前工作目录: $(pwd)"
          echo "打包目录内容:"
          ls -la "/tmp/glibc/" || echo "/tmp/glibc 不存在"
          ls -la "/tmp/glibc/lib32/" || echo "/tmp/glibc/lib32 不存在"
          
          # 创建完整包
          cd /tmp
          tar -czf "glibc-${VERSION}-armhf-full.tar.gz" glibc/
          
          # 创建最小包 (只包含lib32)
          tar -czf "glibc-${VERSION}-armhf-minimal.tar.gz" -C glibc lib32/
          
          # 创建基础包
          tar -czf "glibc-${VERSION}-armhf-basic.tar.gz" glibc/lib32/
          
          # 复制到工作目录
          cp "glibc-${VERSION}-armhf-full.tar.gz" "$GITHUB_WORKSPACE/"
          cp "glibc-${VERSION}-armhf-minimal.tar.gz" "$GITHUB_WORKSPACE/"
          cp "glibc-${VERSION}-armhf-basic.tar.gz" "$GITHUB_WORKSPACE/"
          cp "glibc/version.txt" "$GITHUB_WORKSPACE/"
          
          echo "打包完成的文件:"
          ls -la "$GITHUB_WORKSPACE/"*.tar.gz
          echo "ARTIFACT_FULL=glibc-${VERSION}-armhf-full.tar.gz" >> $GITHUB_ENV
          echo "ARTIFACT_MIN=glibc-${VERSION}-armhf-minimal.tar.gz" >> $GITHUB_ENV
          echo "ARTIFACT_BASIC=glibc-${VERSION}-armhf-basic.tar.gz" >> $GITHUB_ENV
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: glibc-armhf-packages
          path: |
            ${{ env.ARTIFACT_FULL }}
            ${{ env.ARTIFACT_MIN }}
            ${{ env.ARTIFACT_BASIC }}
            version.txt
