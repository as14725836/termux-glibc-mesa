name: Build Glibc for ARMhf (简化版)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      glibc_version:
        description: "Glibc版本"
        required: true
        default: "2.41"
  
jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: 安装ARMhf交叉编译工具
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            wget xz-utils
      
      - name: 下载Glibc源代码
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          wget "https://ftp.gnu.org/gnu/glibc/glibc-${VERSION}.tar.xz" || \
          wget "https://ftp.gnu.org/gnu/glibc/glibc-${VERSION}.tar.gz"
          
          if [ -f "glibc-${VERSION}.tar.xz" ]; then
            tar -xf "glibc-${VERSION}.tar.xz"
          elif [ -f "glibc-${VERSION}.tar.gz" ]; then
            tar -xzf "glibc-${VERSION}.tar.gz"
          fi
      
      - name: 配置和编译ARMhf Glibc
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          cd glibc-${VERSION}
          
          mkdir -p build
          cd build
          
          # 配置为ARMhf
          ../configure \
            --prefix=/usr \
            --host=arm-linux-gnueabihf \
            --disable-multilib
          
          # 编译
          make -j$(nproc)
      
      - name: 提取lib32文件
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          cd glibc-${VERSION}/build
          
          # 创建lib32目录结构
          mkdir -p ../../../glibc/lib32
          
          # 安装到临时位置
          DESTDIR="../../../temp_install" make install
          
          # 复制关键库文件到lib32
          cp -r ../../../temp_install/usr/lib/arm-linux-gnueabihf/* ../../../glibc/lib32/
          cp -r ../../../temp_install/lib/arm-linux-gnueabihf/* ../../../glibc/lib32/
          
          # 清理临时文件
          rm -rf ../../../temp_install
      
      - name: 打包lib32
        run: |
          VERSION="${{ github.event.inputs.glibc_version }}"
          
          # 打包glibc/lib32文件夹
          tar -czf "glibc-${VERSION}-armhf-lib32.tar.gz" -C glibc lib32
          
          echo "ARTIFACT=glibc-${VERSION}-armhf-lib32.tar.gz" >> $GITHUB_ENV
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: glibc-armhf-lib32
          path: ${{ env.ARTIFACT }}
